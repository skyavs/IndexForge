<!DOCTYPE html>

<html><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>IndexForge - Build Financial Indices Without Code</title>
<link href="/logo_192x192.png" rel="icon" type="image/png"/>
<script src="https://cdn.tailwindcss.com/3.4.16"></script>
<script>tailwind.config={theme:{extend:{colors:{primary:'#3b82f6',secondary:'#1e40af'},borderRadius:{'none':'0px','sm':'4px',DEFAULT:'8px','md':'12px','lg':'16px','xl':'20px','2xl':'24px','3xl':'32px','full':'9999px','button':'8px'}}}}</script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@700&amp;family=Pacifico&amp;display=swap" rel="stylesheet"/>
<style>
input#show-custom-index:checked + label span > #show-custom-index-indicator {
  background-color: rgba(87, 181, 231, 1); /* Custom Index: синий */
  display: block;
}
input#show-sp500:checked + label span > #show-sp500-indicator {
  background-color: rgba(141, 211, 199, 1); /* S&P 500: зелёный */
  display: block;
}
</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css" rel="stylesheet"/>
<style>
:where([class^="ri-"])::before { content: "\f3c2"; }
body {
font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
background-color: #0f172a;
color: #f8fafc;
}
h1, h2, h3, h4, .font-heading {
font-family: 'Inter', sans-serif;
font-weight: 700;
letter-spacing: -0.02em;
}
.text-gradient {
background: linear-gradient(135deg, #60A5FA 0%, #3B82F6 50%, #1D4ED8 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
-webkit-appearance: none;
margin: 0;
}
input[type="number"] {
-moz-appearance: textfield;
}
.custom-switch {
position: relative;
display: inline-block;
width: 40px;
height: 22px;
}
.custom-switch input {
opacity: 0;
width: 0;
height: 0;
}
.slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: #334155;
transition: .4s;
border-radius: 22px;
}
.slider:before {
position: absolute;
content: "";
height: 16px;
width: 16px;
left: 3px;
bottom: 3px;
background-color: white;
transition: .4s;
border-radius: 50%;
}
input:checked + .slider {
background-color: #3b82f6;
}
input:checked + .slider:before {
transform: translateX(18px);
}
.toggle-btn {
background-color: #1e293b;
color: #94a3b8;
transition: all 0.3s;
}
.toggle-btn.active {
background-color: #3b82f6;
color: white;
}
.progress-bar {
position: relative;
display: flex;
justify-content: space-between;
counter-reset: step;
margin-bottom: 30px;
}
.progress-bar::before {
content: "";
position: absolute;
top: 15px;
left: 0;
height: 2px;
width: 100%;
background-color: #334155;
z-index: 0;
}
.progress-step {
position: relative;
z-index: 1;
display: flex;
flex-direction: column;
align-items: center;
}
.step-circle {
width: 30px;
height: 30px;
border-radius: 50%;
background-color: #1e293b;
color: #94a3b8;
display: flex;
align-items: center;
justify-content: center;
font-weight: 600;
margin-bottom: 8px;
}
.progress-step.active .step-circle {
background-color: #3b82f6;
color: white;
box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
}
.progress-step.completed .step-circle {
background-color: #10b981;
color: white;
}
.progress-step-text {
font-size: 0.875rem;
color: #94a3b8;
}
.progress-step.active .progress-step-text {
color: white;
}
.glow-effect {
box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
}
.custom-scrollbar::-webkit-scrollbar {
width: 6px;
}
.custom-scrollbar::-webkit-scrollbar-track {
background: #1e293b;
border-radius: 10px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
background: #3b82f6;
border-radius: 10px;
}
</style>
<!-- Color Refresh: clearer, higher‑contrast palette -->
<style id="color-refresh">
  /* Brand & background */
  body               { background-color:#0e1627; color:#f1f5f9; }
  .bg-gray-900       { background-color:#0e1627 !important; }
  .bg-gray-800       { background-color:#1e293b !important; }
  .bg-gray-800\/90  { background-color:rgba(30,41,59,0.95) !important; }
  .bg-gray-800\/50  { background-color:rgba(30,41,59,0.85) !important; }
  .bg-gray-700       { background-color:#334155 !important; }
  .text-gray-100     { color:#f8fafc !important; }
  .text-gray-400     { color:#cbd5e1 !important; }
  .border-gray-800   { border-color:#1e293b !important; }
  .border-gray-700   { border-color:#334155 !important; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script><style>
input#show-custom-index:checked + span::before {
  background-color: rgba(87, 181, 231, 1); /* синий */
}
input#show-sp500:checked + span::before {
  background-color: rgba(141, 211, 199, 1); /* зелёный */
}
</style><style>
@media (max-width: 639px){
  .component-row{flex-wrap:wrap;}
  .component-price{margin-left:auto;}
}
@media (min-width: 640px){
  .component-row{flex-wrap:nowrap;}
}
</style></head><body><script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

document.addEventListener("DOMContentLoaded", function () {
    const supabaseUrl = "https://ftyfslzxtqalylwekjcv.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0eWZzbHp4dHFhbHlsd2VramN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1OTU0NDEsImV4cCI6MjA2NTE3MTQ0MX0.7UNbOoclq4s-3M1o95-c3pmie0S5eRpXdPf1f755gbE";
    window.supabase = createClient(supabaseUrl, supabaseKey);
});
</script><header class="bg-[url('https://static.readdy.ai/image/138f22226b13515669693e424a3b6751/0e290a13f2dafb56bfb369f7e3d4d239.png')] bg-cover bg-center fixed w-full z-50 border-b border-blue-900/30">
<nav class="container mx-auto px-6 py-2">
<div class="flex justify-between items-center">
<div class="flex items-center gap-4">
<a class="flex items-center gap-4 hover:opacity-90 transition-opacity scroll-smooth" href="#"><img alt="IndexForge Logo" class="w-auto max-h-8 h-auto" src="/logo_192x192.png"/><span class="text-xl font-['Inter'] font-bold bg-[linear-gradient(120deg,#E0F4FF,#87CEEB)] bg-clip-text text-transparent [text-shadow:0_0_20px_rgba(135,206,235,0.3)]">IndexForge</span></a>
</div>
<div class="hidden md:flex items-center space-x-4">
<a class="text-gray-100 hover:text-white px-4 py-2 hover:bg-white/10 rounded transition-all scroll-smooth" data-en="Home" data-fr="Accueil" href="#">Home</a>
<a class="text-gray-100 hover:text-white px-4 py-2 hover:bg-white/10 rounded transition-all scroll-smooth" data-en="About" data-fr="À propos" href="#team">About</a>
<a class="text-gray-100 hover:text-white px-4 py-2 hover:bg-white/10 rounded transition-all scroll-smooth" data-en="Contact" data-fr="Contact" href="#contact">Contact</a>
<a class="bg-primary text-white hover:bg-primary/90 px-4 py-2 rounded font-medium transition-all scroll-smooth" data-en="Demo" data-fr="Démo" href="#demo">Demo</a>
<div class="relative">
<button class="flex items-center gap-2 px-4 py-2.5 text-sm font-medium bg-gray-800/50 hover:bg-gray-700/50 text-gray-100 rounded" id="language-selector">
<i class="ri-global-line"></i>
<span id="current-language">English</span>
<i class="ri-arrow-down-s-line"></i>
</button>
</div>
</div>
<div class="flex items-center gap-2 md:hidden">
<div class="relative">
<button class="flex items-center gap-1 px-2 py-1 text-sm font-medium bg-gray-800/50 hover:bg-gray-700/50 text-gray-100 rounded" id="mobile-language-selector" style="">
<i class="ri-global-line"></i>
</button>
</div>
<button class="text-gray-600" id="mobile-menu-button">
<i class="ri-menu-line text-2xl"></i>
</button>
</div>
</div>
<div class="md:hidden hidden" id="mobile-menu">
<div class="py-4 space-y-4">
<a class="block text-gray-100 hover:text-white scroll-smooth text-right pr-4" data-en="Home" data-fr="Accueil" href="#">Home</a>
<a class="block text-gray-100 hover:text-white scroll-smooth text-right pr-4" data-en="About" data-fr="À propos" href="#team">About</a>
<a class="block text-gray-100 hover:text-white scroll-smooth text-right pr-4" data-en="Contact" data-fr="Contact" href="#contact">Contact</a>
<a class="block text-primary font-medium hover:text-primary/80 scroll-smooth text-right pr-4" data-en="Demo" data-fr="Démo" href="#demo">Demo</a>
</div>
</div>
</nav>
</header><section class="py-20 bg-[#0B1120]" id="demo">
<div class="container mx-auto px-6">
<div class="text-center mb-16">
<h2 class="text-3xl font-bold text-white mb-4 font-heading" data-en="Try Our Index Builder" data-fr="Feuille de route du produit">Try Our Index Builder</h2>
<p class="text-xl text-gray-600" data-en="The MVP is live — explore real data and instant results. No code, no wait — your custom index in seconds." data-fr="La version MVP est en ligne — explorez des données réelles et des résultats instantanés. Aucun code, aucun délai — votre indice personnalisé en quelques secondes.">The MVP is live — explore real data and instant results. No code, no wait — your custom index in seconds.</p>
</div>
<main class="container mx-auto px-6 py-8">
<div class="progress-bar mb-10 px-10">
<div class="progress-step active" data-step="1">
<div class="step-circle">1</div>
<div class="progress-step-text" data-en="Define &amp; Backtest" data-fr="Définir &amp; Backtester">Define &amp; Backtest</div>
</div>
<div class="progress-step" data-step="2">
<div class="step-circle">2</div>
<div class="progress-step-text" data-en="Analyze Results" data-fr="Analyser les Résultats">Analyze Results</div>
</div>
<div class="progress-step" data-step="3">
<div class="step-circle">3</div>
<div class="progress-step-text" data-en="Prepare Launch" data-fr="Préparer le Lancement">Prepare Launch</div>
</div>
</div>
<div class="step-content" id="step-1">
<!-- Components selection panel -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<!-- Model Configuration Panel -->
<div class="bg-gray-900 rounded p-6 border border-gray-800 flex flex-col h-full">
<h2 class="text-xl font-semibold mb-6" data-en="Model Configuration" data-fr="Configuration du Modèle">Model Configuration</h2>
<div class="mb-6">
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Index Model Type" data-fr="Type de Modèle d'Indice">Index Model Type</label>
<div class="relative">
<select class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-primary" id="model-type">
<option data-en="Price Weighted" data-fr="Pondéré par Prix" value="price-weighted">Price Weighted</option>
<option data-en="Equal Weighted" data-fr="Pondération Égale" value="equal-weighted">Equal Weighted</option>
</select>
<div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
<i class="ri-arrow-down-s-line text-gray-400"></i>
</div>
</div>
</div>
<div class="hidden" id="equal-weighted-params">
<div class="mb-6">
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Initial Index Value" data-fr="Valeur Initiale de l'Indice">Initial Index Value</label>
<input class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-primary" id="initial-value" type="number" value="100"/>
</div><div class="mb-6" id="rebalance-wrapper"><label class="block text-sm font-medium text-gray-400 mb-2" data-en="Rebalance Frequency" data-fr="Fréquence de Rééquilibrage" for="rebalance-frequency">Rebalance Frequency</label><div class="relative"><select class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-primary" id="rebalance-frequency" name="rebalance-frequency"><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option></select><div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none"><i class="ri-arrow-down-s-line text-gray-400"></i></div></div></div>
</div>
<div class="hidden" id="user-defined-params">
<div class="mb-6">
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Divisor Type" data-fr="Type de Diviseur">Divisor Type</label>
<div class="relative">
<select class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-primary" id="divisor-type">
<option data-en="Fixed Value" data-fr="Valeur Fixe" value="fixed">Fixed Value</option>
<option data-en="Normalized to Date" data-fr="Normalisé à la Date" value="normalized">Normalized to Date</option>
</select>
<div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
<i class="ri-arrow-down-s-line text-gray-400"></i>
</div>
</div>
</div>
<div class="mb-6" id="fixed-divisor">
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Divisor Value" data-fr="Valeur du Diviseur">Divisor Value</label>
<input class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary" id="divisor-value" type="number" value="1"/>
</div>
<div class="mb-6 hidden" id="normalized-divisor">
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Normalization Date" data-fr="Date de Normalisation">Normalization Date</label>
<input class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary" id="normalization-date" type="date"/>
</div>
</div>
<div class="mt-auto">
<div class="border-t border-gray-800 pt-6 mb-6">
<h3 class="text-lg font-medium mb-4" data-en="Backtesting Period" data-fr="Période de Backtesting">Backtesting Period</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Start Date" data-fr="Date de Début">Start Date</label>
<input class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-primary" id="start-date" type="date"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="End Date" data-fr="Date de Fin">End Date</label>
<input class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-primary" id="end-date" type="date"/>
</div>
</div>
<div class="flex space-x-2">
<button class="period-btn px-3 py-1 bg-gray-800 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-700" data-period="3M">3M</button>
<button class="period-btn px-3 py-1 bg-gray-800 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-700" data-period="6M">6M</button>
<button class="period-btn px-3 py-1 bg-gray-800 text-gray-400 rounded-full text-sm font-medium hover:bg-gray-700" data-period="1Y">1Y</button>
</div>
</div>
</div>
</div>
<!-- Available Components Panel -->
<div class="bg-gray-900 rounded p-6 border border-gray-800">
<h2 class="text-xl font-semibold mb-6" data-en="Available Components" data-fr="Composants Disponibles">Available Components</h2>
<div class="mb-4">
<div class="relative">
<input class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 pl-10 pr-3 focus:outline-none focus:ring-2 focus:ring-primary" data-en-placeholder="Search by symbol or name..." data-fr-placeholder="Rechercher par symbole ou nom..." id="component-search" placeholder="Search by symbol or name..." type="text"/>
<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
<i class="ri-search-line text-gray-400"></i>
</div>
</div>
</div>
<div class="mb-4 grid grid-cols-1 sm:grid-cols-2 gap-2 w-full">
<div class="relative w-full">
<select class="w-full bg-gray-800 border border-gray-700 rounded text-white py-1 px-3 pr-8 appearance-none text-sm focus:outline-none focus:ring-2 focus:ring-primary" id="sector-filter">
<option data-en="All Sectors" data-fr="Tous les Secteurs" value="">All Sectors</option>
<option data-en="Technology" data-fr="Technologie" value="technology">Technology</option>
<option data-en="Finance" data-fr="Finance" value="finance">Finance</option>
<option data-en="Healthcare" data-fr="Santé" value="healthcare">Healthcare</option>
<option data-en="Consumer" data-fr="Consommation" value="consumer">Consumer</option>
<option data-en="Energy" data-fr="Énergie" value="energy">Energy</option>
</select>
<div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
<i class="ri-arrow-down-s-line text-gray-400 text-sm"></i>
</div>
</div>
<div class="relative w-full">
<select class="w-full bg-gray-800 border border-gray-700 rounded text-white py-1 px-3 pr-8 appearance-none text-sm focus:outline-none focus:ring-2 focus:ring-primary" id="region-filter">
<option data-en="All Regions" data-fr="Toutes les Régions" value="">All Regions</option>
<option data-en="North America" data-fr="Amérique du Nord" value="north-america">North America</option>
<option data-en="Europe" data-fr="Europe" value="europe">Europe</option>
<option data-en="Asia Pacific" data-fr="Asie-Pacifique" value="asia-pacific">Asia Pacific</option>
<option data-en="Emerging Markets" data-fr="Marchés Émergents" value="emerging">Emerging Markets</option>
</select>
<div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
<i class="ri-arrow-down-s-line text-gray-400 text-sm"></i>
</div>
</div>
</div>
<div class="mb-4 flex justify-between">
<button class="text-sm text-primary hover:text-blue-400 font-medium" data-en="Select All" data-fr="Sélectionner Tout" id="select-all">Select All</button>
<button class="text-sm text-gray-400 hover:text-gray-300 font-medium" data-en="Clear All" data-fr="Effacer Tout" id="clear-all">Clear All</button>
</div>
<div class="h-[400px] overflow-y-auto custom-scrollbar">
<div class="space-y-2" id="available-components">
<!-- Component items will be generated by JavaScript -->
</div>
</div>
</div>
<!-- Selected Components Panel -->
<div class="bg-gray-900 rounded p-6 border border-gray-800">
<div class="flex justify-between items-center mb-6">
<h2 class="text-xl font-semibold" data-en="Selected Components" data-fr="Composants Sélectionnés">Selected Components</h2>
<div class="flex items-center gap-3">
<div class="bg-gray-800 px-3 py-1 rounded-full">
<span class="text-sm text-gray-400" data-en="Selected:" data-fr="Sélectionnés:">Selected:</span>
<span class="text-white font-medium" id="selected-count">0</span>
</div>
</div>
</div>
<div class="hidden mb-6" id="weight-type-toggle">
<div class="text-sm font-medium text-gray-400 mb-2" data-en="Input Type" data-fr="Type de Saisie">Input Type</div>
<div class="flex bg-gray-800 rounded-full p-1">
<button class="weight-toggle weights-toggle active flex-1 py-1 px-3 rounded-full text-sm font-medium whitespace-nowrap" data-en="Weights (%)" data-fr="Poids (%)">Weights (%)</button>
<button class="weight-toggle amounts-toggle flex-1 py-1 px-3 rounded-full text-sm font-medium whitespace-nowrap" data-en="Amounts" data-fr="Montants">Amounts</button>
</div>
</div>
<div class="flex gap-3 mb-6">
<button class="flex-1 bg-primary hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-button transition-colors duration-200 flex items-center justify-center gap-2" id="import-csv">
<i class="ri-upload-2-line"></i>
<span data-en="Import CSV" data-fr="Importer CSV">Import CSV</span>
</button>
<button class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-button transition-colors duration-200 flex items-center justify-center gap-2" id="download-template">
<i class="ri-download-2-line"></i>
<span data-en="Template" data-fr="Modèle">Template</span>
</button>
</div>
<input accept=".csv" class="hidden" id="csv-file-input" type="file"/>
<div class="text-center py-10 text-gray-400" data-en="No components selected. Add components from the available list." data-fr="Aucun composant sélectionné. Ajoutez des composants depuis la liste disponible." id="selected-components-empty">
No components selected. Add components from the available list.
</div>
<div class="hidden" id="selected-components-container">
<div class="h-[400px] overflow-y-auto custom-scrollbar">
<div class="space-y-3" id="selected-components">
<!-- Selected component items will be generated by JavaScript -->
</div>
</div>
</div>
</div>
</div>
</div>
<div class="step-content hidden" id="step-2">
<div class="grid gap-6 grid-cols-1 lg:grid-cols-12">
<!-- Chart Controls Panel -->
<div class="bg-gray-900 rounded p-6 border border-gray-800 lg:col-span-2">
<h2 class="text-xl font-semibold mb-6" data-en="Chart Controls" data-fr="Contrôles du Graphique">Chart Controls</h2>
<div class="mb-6">
<div class="flex flex-col gap-4">
<!-- Value Mode -->
<div class="flex flex-col gap-2 w-full" id="value-mode-toggle">
<div class="text-sm font-medium text-gray-400 mb-1">Display Mode</div>
<button class="bg-blue-500 text-white rounded-md hover:bg-slate-600 w-full px-2 py-1.5 text-xs" data-mode="normalize">Normalize to 100</button>
<button class="bg-slate-700 text-white rounded-md w-full px-2 py-1.5 text-xs" data-mode="absolute">Absolute</button>
<button class="bg-slate-700 text-white rounded-md hover:bg-slate-600 w-full px-2 py-1.5 text-xs" data-mode="return">Return %</button>
</div>
<!-- Scale Mode -->
</div>
</div>
<div class="mb-6 hidden">
<div class="text-sm font-medium text-gray-400 mb-2" data-en="Series" data-fr="Séries">Series</div>
<div class="space-y-2">
<div class="flex items-center">
<input class="hidden" id="show-custom-index" type="checkbox"/>
<label class="flex items-center cursor-pointer" for="show-custom-index">
<span class="w-4 h-4 inline-block mr-2 rounded border border-gray-400 flex-shrink-0 relative">
<span class="absolute inset-0 hidden bg-primary rounded-sm" id="show-custom-index-indicator"></span>
</span>
<span class="text-sm" data-en="Custom Index" data-fr="Indice Personnalisé">Custom Index</span>
</label>
</div>
<div class="flex items-center">
<input class="hidden" id="show-sp500" type="checkbox"/>
<label class="flex items-center cursor-pointer" for="show-sp500">
<span class="w-4 h-4 inline-block mr-2 rounded border border-gray-400 flex-shrink-0 relative">
<span class="absolute inset-0 hidden bg-blue-400 rounded-sm" id="show-sp500-indicator"></span>
</span>
<span class="text-sm">S&amp;P 500</span>
</label>
</div>
</div>
</div>
<div class="border-t border-gray-800 pt-6">
</div>
</div>
<!-- Chart Panel -->
<div class="bg-gray-900 rounded p-6 border border-gray-800 lg:col-span-8">
<h2 class="text-xl font-semibold mb-6" data-en="Performance Analysis" data-fr="Analyse de Performance">Performance Analysis</h2>
<div class="w-full h-[500px] flex-grow" id="performance-chart"></div>
<div class="grid gap-4 mt-6 grid-cols-[repeat(auto-fit,minmax(220px,1fr))]">
<div class="px-4 bg-gray-800 rounded py-3 min-h-0 p-4">
<div class="text-sm text-gray-400 mb-1" data-en="Returns" data-fr="Rendements">Returns</div>
<div class="grid grid-cols-2 gap-4 mt-2"><div class="flex justify-between text-sm font-medium leading-tight"><span class="text-gray-300">1M</span><span class="text-green-400" id="ret-1m">+3.2%</span></div><div class="flex justify-between text-sm font-medium leading-tight"><span class="text-gray-300">3M</span><span class="text-green-400" id="ret-3m">+8.7%</span></div><div class="flex justify-between text-sm font-medium leading-tight"><span class="text-gray-300">YTD</span><span class="text-green-400" id="ret-ytd">+16.3%</span></div><div class="flex justify-between text-sm font-medium leading-tight"><span class="text-gray-300">1Y</span><span class="text-green-400" id="ret-1y">+24.8%</span></div></div></div>
<div class="px-4 bg-gray-800 rounded py-3 min-h-0 p-4">
<div class="text-sm text-gray-400 mb-1" data-en="Benchmark Comparison" data-fr="Comparaison avec Benchmark">Benchmark Comparison</div>
<div class="grid gap-4 mt-2 text-sm font-medium leading-tight grid-cols-[2fr_1fr]"><div class="text-gray-300">Final S&amp;P 500 Value</div><div class="text-white" id="bench-final">121.7</div><div class="text-gray-300">vs S&amp;P 500</div><div class="text-green-400" id="bench-vs">+5.2%</div></div></div>
</div>
</div>
<div class="bg-gray-900 rounded p-6 border border-gray-800 lg:col-span-2"><h3 class="text-lg font-medium mb-4" data-en="Key Metrics" data-fr="Métriques Clés">Key Metrics</h3><div class="grid grid-cols-1 gap-4">
<div class="w-full bg-gray-800 rounded-md p-4 text-sm space-y-1">
<div class="text-xs text-gray-400 mb-1" data-en="Total Returns" data-fr="Rendements (1A)">Total Returns (Backtest period)</div>
<div class="text-lg font-semibold text-green-400" id="metric-total-returns">+24.8%</div>
</div>
<div class="w-full bg-gray-800 rounded-md p-4 text-sm space-y-1"><div class="text-xs text-gray-400 mb-1" data-en="Final Value" data-fr="Valeur Finale">Final Value</div><div class="text-lg font-semibold" id="metric-final-value">121.70</div></div><div class="w-full bg-gray-800 rounded-md p-4 text-sm space-y-1">
<div class="text-xs text-gray-400 mb-1" data-en="Volatility" data-fr="Volatilité">Volatility</div>
<div class="text-lg font-semibold" id="metric-volatility">18.2%</div>
</div>
<div class="w-full bg-gray-800 rounded-md p-4 text-sm space-y-1">
<div class="text-xs text-gray-400 mb-1" data-en="Sharpe Ratio" data-fr="Ratio de Sharpe">Sharpe Ratio</div>
<div class="text-lg font-semibold" id="metric-sharpe">1.36</div>
</div>
<div class="w-full bg-gray-800 rounded-md p-4 text-sm space-y-1">
<div class="text-xs text-gray-400 mb-1" data-en="Max Drawdown" data-fr="Drawdown Max">Max Drawdown</div>
<div class="text-lg font-semibold text-red-400" id="metric-mdd">-12.4%</div>
</div>
</div></div></div>
</div>
<div class="step-content hidden" id="step-3">
<div class="max-w-3xl mx-auto bg-gray-900 rounded p-8 border border-gray-800">
<h2 class="text-2xl font-semibold mb-8 text-center" data-en="Prepare Index for Launch" data-fr="Préparer l'Indice pour le Lancement">Prepare Index for Launch</h2>
<div class="mb-8">
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Index Name" data-fr="Nom de l'Indice">Index Name</label>
<input class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary" data-en-placeholder="e.g. Tech Leaders Index" data-fr-placeholder="ex. Indice des Leaders Technologiques" id="index-name" placeholder="e.g. Tech Leaders Index" type="text"/>
</div>
<div class="mb-8">
<h3 class="text-lg font-medium mb-4" data-en="Calculation Schedule" data-fr="Calendrier de Calcul">Calculation Schedule</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
<div>
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Calculation Time" data-fr="Heure de Calcul">Calculation Time</label>
<input class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary" id="calc-time" type="time" value="13:00"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Timezone" data-fr="Fuseau Horaire">Timezone</label>
<div class="relative">
<select class="w-full bg-gray-800 border border-gray-700 rounded text-white py-2 px-3 pr-8 appearance-none focus:outline-none focus:ring-2 focus:ring-primary" id="timezone">
<option value="UTC">UTC</option>
<option value="EST">EST (UTC-5)</option>
<option value="CET">CET (UTC+1)</option>
<option value="JST">JST (UTC+9)</option>
</select>
<div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
<i class="ri-arrow-down-s-line text-gray-400"></i>
</div>
</div>
</div>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-400 mb-2" data-en="Calculation Days" data-fr="Jours de Calcul">Calculation Days</label>
<div class="flex flex-wrap gap-2">
<label class="day-checkbox flex items-center bg-gray-800 px-3 py-1 rounded cursor-pointer peer-checked:bg-blue-600">
<input checked="" class="hidden peer" type="checkbox" value="mon"/>
<span class="day-indicator w-3 h-3 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="Mon" data-fr="Lun">Mon</span>
</label>
<label class="day-checkbox flex items-center bg-gray-800 px-3 py-1 rounded cursor-pointer peer-checked:bg-blue-600">
<input checked="" class="hidden peer" type="checkbox" value="tue"/>
<span class="day-indicator w-3 h-3 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="Tue" data-fr="Mar">Tue</span>
</label>
<label class="day-checkbox flex items-center bg-gray-800 px-3 py-1 rounded cursor-pointer peer-checked:bg-blue-600">
<input checked="" class="hidden peer" type="checkbox" value="wed"/>
<span class="day-indicator w-3 h-3 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="Wed" data-fr="Mer">Wed</span>
</label>
<label class="day-checkbox flex items-center bg-gray-800 px-3 py-1 rounded cursor-pointer peer-checked:bg-blue-600">
<input checked="" class="hidden peer" type="checkbox" value="thu"/>
<span class="day-indicator w-3 h-3 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="Thu" data-fr="Jeu">Thu</span>
</label>
<label class="day-checkbox flex items-center bg-gray-800 px-3 py-1 rounded cursor-pointer peer-checked:bg-blue-600">
<input checked="" class="hidden peer" type="checkbox" value="fri"/>
<span class="day-indicator w-3 h-3 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="Fri" data-fr="Ven">Fri</span>
</label>
<label class="day-checkbox flex items-center bg-gray-800 px-3 py-1 rounded cursor-pointer peer-checked:bg-blue-600">
<input class="hidden peer" type="checkbox" value="sat"/>
<span class="day-indicator w-3 h-3 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="Sat" data-fr="Sam">Sat</span>
</label>
<label class="day-checkbox flex items-center bg-gray-800 px-3 py-1 rounded cursor-pointer peer-checked:bg-blue-600">
<input class="hidden peer" type="checkbox" value="sun"/>
<span class="day-indicator w-3 h-3 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="Sun" data-fr="Dim">Sun</span>
</label>
</div>
</div>
</div>
<div class="mb-8">
<h3 class="text-lg font-medium mb-4" data-en="Calculation Frequency" data-fr="Fréquence de Calcul">Calculation Frequency</h3>
<div class="flex flex-wrap gap-3 mb-4">
<label class="frequency-radio flex items-center bg-gray-800 px-4 py-2 rounded cursor-pointer peer-checked:bg-blue-600">
<input checked="" class="hidden peer" name="frequency" type="radio" value="eod"/>
<span class="radio-indicator w-4 h-4 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="End of Day" data-fr="Fin de Journée">End of Day</span>
</label>
<label class="frequency-radio flex items-center bg-gray-800 px-4 py-2 rounded cursor-pointer peer-checked:bg-blue-600">
<input class="hidden peer" name="frequency" type="radio" value="hourly"/>
<span class="radio-indicator w-4 h-4 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="Hourly" data-fr="Horaire">Hourly</span>
</label>
<label class="frequency-radio flex items-center bg-gray-800 px-4 py-2 rounded cursor-pointer peer-checked:bg-blue-600">
<input class="hidden peer" name="frequency" type="radio" value="realtime"/>
<span class="radio-indicator w-4 h-4 inline-block mr-2 rounded-full border border-gray-400 peer-checked:bg-blue-500"></span>
<span class="text-sm" data-en="Real-time" data-fr="Temps Réel">Real-time</span>
</label>
</div>
</div>
<div class="mb-8">
<h3 class="text-lg font-medium mb-4" data-en="Distribution Settings" data-fr="Paramètres de Distribution">Distribution Settings</h3>
<div class="space-y-3">
<label class="flex items-center justify-between">
<span class="text-sm" data-en="Email Notifications" data-fr="Notifications par Email">Email Notifications</span>
<label class="custom-switch">
<input checked="" class="peer" type="checkbox"/>
<span class="slider"></span>
</label>
</label>
<label class="flex items-center justify-between">
<span class="text-sm" data-en="API Access" data-fr="Accès API">API Access</span>
<label class="custom-switch">
<input checked="" class="peer" type="checkbox"/>
<span class="slider"></span>
</label>
</label>
<label class="flex items-center justify-between">
<span class="text-sm" data-en="Public Dashboard" data-fr="Tableau de Bord Public">Public Dashboard</span>
<label class="custom-switch">
<input type="checkbox"/>
<span class="slider"></span>
</label>
</label>
</div>
</div>
<div class="mb-8 bg-gray-800 p-4 rounded">
<h3 class="text-lg font-medium mb-3" data-en="Final Review" data-fr="Révision Finale">Final Review</h3>
<div class="space-y-2">
<div class="flex items-center">
<div class="w-5 h-5 flex items-center justify-center text-green-400 mr-2">
<i class="ri-check-line"></i>
</div>
<span class="text-sm" data-en="Index model and components validated" data-fr="Modèle d'indice et composants validés">Index model and components validated</span>
</div>
<div class="flex items-center">
<div class="w-5 h-5 flex items-center justify-center text-green-400 mr-2">
<i class="ri-check-line"></i>
</div>
<span class="text-sm" data-en="Backtesting results reviewed" data-fr="Résultats de backtesting examinés">Backtesting results reviewed</span>
</div>
<div class="flex items-center">
<div class="w-5 h-5 flex items-center justify-center text-green-400 mr-2">
<i class="ri-check-line"></i>
</div>
<span class="text-sm" data-en="Calculation schedule configured" data-fr="Calendrier de calcul configuré">Calculation schedule configured</span>
</div>
<div class="flex items-center">
<div class="w-5 h-5 flex items-center justify-center text-yellow-400 mr-2">
<i class="ri-error-warning-line"></i>
</div>
<span class="text-sm" data-en="Data subscription required for real-time calculation" data-fr="Abonnement aux données requis pour le calcul en temps réel">Data subscription required for real-time calculation</span>
</div>
</div>
</div>
<button class="w-full bg-gray-700 cursor-not-allowed text-gray-400 font-medium py-3 px-4 rounded-button transition-colors duration-200 flex items-center justify-center" disabled="" id="launch-index">
<i class="ri-rocket-line mr-2"></i>
<span data-en="Launch Index (Coming Soon)" data-fr="Lancer l'Indice (Bientôt Disponible)">Launch Index (Coming Soon)</span>
</button>
</div>
</div>
<div class="mt-10 flex justify-between">
<button class="bg-gray-800 hover:bg-gray-700 text-white font-medium py-2 px-6 rounded-button transition-colors duration-200 flex items-center justify-center opacity-50 cursor-not-allowed" id="prev-step">
<i class="ri-arrow-left-line mr-2"></i>
<span data-en="Previous" data-fr="Précédent">Previous</span>
</button>
<button id="run-backtest-primary"
        class="bg-primary hover:bg-blue-600 text-white font-medium
               py-2 px-6 rounded-button transition-colors duration-200
               flex items-center justify-center gap-2">
  <svg id="run-spinner"
       class="hidden w-4 h-4 animate-spin"
       viewBox="0 0 24 24" fill="none" stroke="currentColor">
    <circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"/>
    <path  d="M4 12a8 8 0 0 1 8-8" stroke-width="4" class="opacity-75"/>
  </svg>
  <span id="run-text">Run Backtest</span>
  <i class="ri-play-circle-line text-lg"></i>
</button>
<button class="bg-primary hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-button transition-colors duration-200 flex items-center justify-center hidden" id="next-step">
<span data-en="Next" data-fr="Suivant">Next</span>
<i class="ri-arrow-right-line ml-2"></i>
</button></button>
</div>
</main>
<!-- About & Team Section -->
<!-- Roadmap Section -->
<!-- Contact Section -->
<!-- Footer -->
<script id="mobile-menu">
document.addEventListener('DOMContentLoaded', function() {
// Model type selection handling
const modelType = document.getElementById('model-type');
const equalWeightedParams = document.getElementById('equal-weighted-params');
const userDefinedParams = document.getElementById('user-defined-params');
const weightTypeToggle = document.getElementById('weight-type-toggle');
const divisorType = document.getElementById('divisor-type');
const fixedDivisor = document.getElementById('fixed-divisor');
const normalizedDivisor = document.getElementById('normalized-divisor');
modelType.addEventListener('change', function() {
equalWeightedParams.classList.add('hidden');
userDefinedParams.classList.add('hidden');
weightTypeToggle.classList.add('hidden');
switch(this.value) {
case 'equal-weighted':
equalWeightedParams.classList.remove('hidden');
break;
case 'user-defined':
userDefinedParams.classList.remove('hidden');
weightTypeToggle.classList.remove('hidden');
break;
}
});
// Weight type toggle handling
const weightToggles = document.querySelectorAll('.weight-toggle');
weightToggles.forEach(toggle => {
toggle.addEventListener('click', function() {
weightToggles.forEach(t => {
t.classList.remove('active', 'bg-primary', 'text-white');
t.classList.add('text-gray-400');
});
this.classList.add('active', 'bg-primary', 'text-white');
this.classList.remove('text-gray-400');
const isAmounts = this.classList.contains('amounts-toggle');
const weightInputs = document.querySelectorAll('.component-weight');
const weightLabels = document.querySelectorAll('.weight-label');
weightInputs.forEach((input, index) => {
if (isAmounts) {
input.placeholder = '0.00';
if (weightLabels[index]) weightLabels[index].textContent = '$';
} else {
input.placeholder = '0';
if (weightLabels[index]) weightLabels[index].textContent = '%';
}
});
});
});
divisorType.addEventListener('change', function() {
if(this.value === 'fixed') {
fixedDivisor.classList.remove('hidden');
normalizedDivisor.classList.add('hidden');
} else {
fixedDivisor.classList.add('hidden');
normalizedDivisor.classList.remove('hidden');
}
});
const mobileMenuButton = document.getElementById('mobile-menu-button');
const mobileMenu = document.getElementById('mobile-menu');
// Add smooth scrolling to all links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
anchor.addEventListener('click', function (e) {
e.preventDefault();
const targetId = this.getAttribute('href');
if (targetId === '#') {
window.scrollTo({
top: 0,
behavior: 'smooth'
});
} else {
document.querySelector(targetId).scrollIntoView({
behavior: 'smooth'
});
}
});
});
mobileMenuButton.addEventListener('click', () => {
mobileMenu.classList.toggle('hidden');
});
// Close mobile menu when clicking on a link
document.querySelectorAll('#mobile-menu a').forEach(link => {
link.addEventListener('click', () => {
mobileMenu.classList.add('hidden');
});
});
});
</script>
<!-- Supabase Components Loader -->
<script type="module">
  let allComponents = [];
  const selected = new Set();
  // Map symbol -> latest close price
  let priceMap = {};

  async function fetchLatestPrices(symbols) {
    if (!symbols || symbols.length === 0) return;
    try {
      // Latest date
      const { data: last, error: errDate } = await supabase
        .from('daily_prices')
        .select('trade_date')
        .order('trade_date', { ascending: false })
        .limit(1);
      if (errDate) throw errDate;
      const lastDate = last?.[0]?.trade_date;
      if (!lastDate) return;

      const { data: prices, error: errPrices } = await supabase
        .from('daily_prices')
        .select('symbol, close')
        .eq('trade_date', lastDate)
        .in('symbol', symbols);
      if (errPrices) throw errPrices;

      priceMap = {};
      prices.forEach(p => priceMap[p.symbol] = Number(p.close));
    } catch(e){ console.error('Price fetch error:', e); }
  }


  async function fetchComponents() {
    const { data, error } = await supabase
      .from("components")
      .select("id, symbol, name")
      .eq("is_active", true)
      .order("symbol", { ascending: true });

    if (error) {
      console.error("Supabase fetch error:", error);
      return;
    }
    allComponents = data;
      // Auto-select FAANG symbols by default
      const defaultSymbols = ['AAPL','AMZN','META','NFLX','GOOGL'];
      defaultSymbols.forEach(sym => {
        const comp = data.find(c => c.symbol === sym);
        if (comp) selected.add(comp.id);
      });
      renderSelectedComponents();
      renderComponentList();

    await fetchLatestPrices(allComponents.map(c=>c.symbol));
    renderComponentList();
  }

  function renderComponentList() {
    const list = document.getElementById("available-components");
    if (!list) return;
    list.innerHTML = "";

    const query = document.getElementById("component-search").value.toLowerCase();
    const filtered = allComponents.filter(c =>
      c.symbol.toLowerCase().includes(query) || c.name.toLowerCase().includes(query)
    );

    filtered.forEach(c => {
      const card = document.createElement("div");
      card.className = "w-full";
      card.innerHTML = `<label class="component-row w-full rounded-lg bg-slate-800 px-3 py-2 flex flex-col">
    <div class="flex items-center w-full">
      <input id="checkbox-${c.id}"
             type="checkbox"
             class="component-checkbox form-checkbox h-4 w-4 text-primary checkbox-selection"
             data-symbol="${c.symbol}"
             ${selected.has(c.id) ? 'checked' : ''}>
      <span class="component-symbol font-semibold text-white ml-2">${c.symbol}</span>
      <span class="component-name hidden sm:inline text-white/70 ml-2">${c.name}</span>
      <span class="component-price font-semibold text-white ml-auto">
        ${priceMap[c.symbol] !== undefined ? '$' + priceMap[c.symbol].toFixed(2) : '--'}
      </span>
    </div>
    <span class="component-name text-xs text-slate-400 ml-8 mt-1 sm:hidden">${c.name}</span>
  </label>`;
      const checkbox = card.querySelector("input");
      checkbox.addEventListener("change", e => {
        if (e.target.checked) {
          selected.add(c.id);
        renderSelectedComponents();
      } else {
          selected.delete(c.id);
        renderSelectedComponents();
      }
      });
      list.appendChild(card);
    });
  }
  function renderSelectedComponents() {
    const list = document.getElementById('selected-components');
    const emptyState = document.getElementById('selected-components-empty');
    const container = document.getElementById('selected-components-container');
    const countEl = document.getElementById('selected-count');
    if (!list) return;
    list.innerHTML = '';
    selected.forEach(id => {
      const comp = allComponents.find(c => c.id === id);
      if (!comp) return;
      const row = document.createElement('div');
      row.className = 'flex items-center justify-between bg-gray-800 rounded-lg py-2 px-3';
      row.innerHTML = `
        <span class="truncate"><span class="font-semibold">${comp.symbol}</span>&nbsp;${comp.name}</span>
        <button data-id="${comp.id}" class="ri-close-line text-gray-400 hover:text-red-500 text-lg remove-selected"></button>
      `;

      // attach remove handler
      row.querySelector('.remove-selected').addEventListener('click', (e) => {
        const id = +e.currentTarget.getAttribute('data-id');
        selected.delete(id);
        renderSelectedComponents();
        renderComponentList();
      });
list.appendChild(row);
    });
    // toggle empty / container
    if (selected.size === 0) {
      emptyState.classList.remove('hidden');
      if(container) container.classList.add('hidden');
    } else {
      emptyState.classList.add('hidden');
      if(container) container.classList.remove('hidden');
    }
    if (countEl) countEl.textContent = selected.size;
    // attach remove listeners
    list.querySelectorAll('.remove-selected').forEach(btn => {
      btn.addEventListener('click', e => {
        const id = parseInt(e.currentTarget.getAttribute('data-id'));
        selected.delete(id);
        const cb = document.getElementById('checkbox-' + id);
        if (cb) cb.checked = false;
        renderSelectedComponents();
      });
    });
  }

  // Search input live filter
  document.addEventListener("DOMContentLoaded", () => {
    const search = document.getElementById("component-search");
    if (search) {
      search.addEventListener("input", renderComponentList);
    }
  });

  // Load on first page load
  document.addEventListener("DOMContentLoaded", fetchComponents);
  // And whenever step 1 is shown again
  window.addEventListener("showStep1", fetchComponents);

</script>
</div></section><footer class="bg-[#0D1424] text-gray-400 py-12">
<div class="container mx-auto px-6">
<div class="grid md:grid-cols-4 gap-8">
<div>
<div class="flex items-center gap-3 mb-4">
<img alt="IndexForge Logo" class="max-w-full max-h-8 h-auto" src="/logo_192x192.png"/>
<span class="text-2xl font-['Inter'] font-bold bg-[linear-gradient(120deg,#E0F4FF,#87CEEB)] bg-clip-text text-transparent [text-shadow:0_0_20px_rgba(135,206,235,0.3)]">IndexForge</span>
</div>
<p class="text-sm" data-en="Building the future of index management technology." data-fr="Construire l’avenir de la technologie de gestion d’indices.">Building the future of index management technology.</p>
</div>
<div>
<h4 class="text-white font-medium mb-4" data-en="Product" data-fr="Produit">Product</h4>
<ul class="space-y-2 text-sm">
<li><a class="hover:text-white" data-en="Features" data-fr="Fonctionnalités" href="#features">Features</a></li>
<li><a class="hover:text-white" data-en="Demo" data-fr="Démo" href="#demo">Demo</a></li>
<li><a class="hover:text-white" data-en="Pricing" data-fr="Tarification" href="#">Pricing</a></li>
<li><a class="hover:text-white" data-en="Documentation" data-fr="Documentation" href="#">Documentation</a></li>
</ul>
</div>
<div>
<h4 class="text-white font-medium mb-4" data-en="Company" data-fr="Entreprise">Company</h4>
<ul class="space-y-2 text-sm">
<li><a class="hover:text-white" data-en="About Us" data-fr="À propos" href="#team">About Us</a></li>
<li><a class="hover:text-white" data-en="Careers" data-fr="Carrières" href="#">Careers</a></li>
<li><a class="hover:text-white" data-en="Blog" data-fr="Blog" href="#">Blog</a></li>
<li><a class="hover:text-white" data-en="Contact" data-fr="Contact" href="#contact">Contact</a></li>
</ul>
</div>
<div>
<h4 class="text-white font-medium mb-4" data-en="Legal" data-fr="Légal">Legal</h4>
<ul class="space-y-2 text-sm">
<li><a class="hover:text-white" data-en="Privacy Policy" data-fr="Politique de confidentialité" href="#">Privacy Policy</a></li>
<li><a class="hover:text-white" data-en="Terms of Service" data-fr="Conditions d’utilisation" href="#">Terms of Service</a></li>
<li><a class="hover:text-white" data-en="Security" data-fr="Sécurité" href="#">Security</a></li>
<li><a class="hover:text-white" data-en="Compliance" data-fr="Conformité" href="#">Compliance</a></li>
</ul>
</div>
</div>
<div class="border-t border-gray-800 mt-12 pt-8 flex flex-col md:flex-row justify-between items-center">
<p class="text-sm">© 2025 IndexForge. All rights reserved.</p>
<div class="flex space-x-6 mt-4 md:mt-0">
<a class="hover:text-white" href="#"><i class="ri-linkedin-fill text-xl"></i></a>
<a class="hover:text-white" href="#"><i class="ri-twitter-fill text-xl"></i></a>
<a class="hover:text-white" href="#"><i class="ri-github-fill text-xl"></i></a>
</div>
</div>
</div>
<p class="text-xs text-center text-gray-500 mt-6" data-en="Not financial advice. For demonstration purposes only." data-fr="Pas un conseil financier. À des fins de démonstration uniquement.">Not financial advice. For demonstration purposes only.</p></footer><script>
let allComponents = [];
const selected = new Set();
let priceMap = {};

async function fetchLatestPrices(symbols) {
  if (!symbols || symbols.length === 0) return;
  try {
    const { data: last, error: errDate } = await window.supabase
      .from('daily_prices')
      .select('trade_date')
      .order('trade_date', { ascending: false })
      .limit(1);
    if (errDate) throw errDate;
    const lastDate = last?.[0]?.trade_date;
    if (!lastDate) return;

    const { data: prices, error: errPrices } = await window.supabase
      .from('daily_prices')
      .select('symbol, close')
      .eq('trade_date', lastDate)
      .in('symbol', symbols);
    if (errPrices) throw errPrices;

    priceMap = {};
    prices.forEach(p => priceMap[p.symbol] = Number(p.close));
  } catch (e) {
    console.error('Price fetch error:', e);
  }
}

async function fetchComponents() {
  try {
    const { data, error } = await window.supabase
      .from("components")
      .select("id, symbol, name, currency, sector")
      .order("symbol", { ascending: true });

    if (error) throw error;

    allComponents = data;
    const listEl = document.getElementById("component-list");
    if (!listEl) return;

    listEl.innerHTML = "";
    for (const c of allComponents) {
      const option = document.createElement("option");
      option.value = c.symbol;
      option.innerText = `${c.symbol} - ${c.name}`;
      listEl.appendChild(option);
    }
  } catch (err) {
    console.error("Component fetch error:", err);
  }
}
</script><script>
document.addEventListener("DOMContentLoaded", function() {
    const modelType = document.getElementById("model-type");
    const rebalance = document.getElementById("rebalance-wrapper");
    function toggle() {
        if (modelType?.value === "equal-weighted") {
            rebalance.style.display = "block";
        } else {
            rebalance.style.display = "none";
        }
    }
    modelType?.addEventListener("change", toggle);
    toggle();
});
</script><script>
document.addEventListener("DOMContentLoaded", function() {
    const modelType = document.getElementById("model-type");
    const rebalance = document.getElementById("rebalance-wrapper");
    function toggle() {
        if (modelType?.value === "equal-weighted") {
            rebalance.style.display = "block";
        } else {
            rebalance.style.display = "none";
        }
    }
    modelType?.addEventListener("change", toggle);
    toggle();
});
</script><script>
document.addEventListener("DOMContentLoaded", function () {
  const startInput = document.getElementById("start-date");
  const endInput = document.getElementById("end-date");

  if (startInput && endInput) {
    const today = new Date();
    let endDate = new Date(today);
    endDate.setDate(endDate.getDate() - 1); // вчера

    // отступаем, если выпал на выходной
    while (endDate.getDay() === 0 || endDate.getDay() === 6) {
      endDate.setDate(endDate.getDate() - 1);
    }

    const startDate = new Date(endDate);
    startDate.setFullYear(startDate.getFullYear() - 1);

    function format(d) {
      return d.toISOString().split("T")[0]; // yyyy-mm-dd
    }

    startInput.value = format(startDate);
    endInput.value = format(endDate);
  }
});
</script><script>
document.addEventListener("DOMContentLoaded", function () {
  const langToggle = document.getElementById("lang-toggle");
  const langMenu = document.getElementById("lang-menu");
  if (langToggle && langMenu) {
    langToggle.addEventListener("click", () => {
      langMenu.classList.toggle("hidden");
    });
  }

  const mobileLangToggle = document.getElementById("mobile-lang-toggle");
  const mobileLangMenu = document.getElementById("mobile-lang-menu");
  if (mobileLangToggle && mobileLangMenu) {
    mobileLangToggle.addEventListener("click", () => {
      mobileLangMenu.classList.toggle("hidden");
    });
  }
});
</script><script>
document.addEventListener("DOMContentLoaded", function () {
  try {

    const desktopToggle = document.getElementById("language-selector");
    const desktopMenu = document.getElementById("language-dropdown");
    const mobileMenu = document.getElementById("mobile-language-dropdown");
    const currentLangSpan = document.getElementById("current-language");
    const langButtons = document.querySelectorAll("[data-lang]");

    let currentLanguage = localStorage.getItem("language");
    if (!currentLanguage) {
      const browserLang = navigator.language || (navigator.languages && navigator.languages[0]) || "en";
      currentLanguage = browserLang.startsWith("fr") ? "fr" : "en";
      console.log("🌐 Using browser language:", browserLang, "→", currentLanguage);
      localStorage.setItem("language", currentLanguage);
    }

    if (desktopToggle && desktopMenu) {
      desktopToggle.addEventListener("click", () => {
        desktopMenu.classList.toggle("hidden");
      });
    }

    const mobileIcon = document.querySelector("header .ri-global-line");
    if (mobileIcon && mobileMenu) {
      mobileIcon.parentElement?.addEventListener("click", () => {
        mobileMenu.classList.toggle("hidden");
      });
    }

    function updateLanguageUI(lang) {
      if (!lang) return;
      currentLanguage = lang;
      localStorage.setItem("language", currentLanguage);

      if (currentLangSpan) currentLangSpan.textContent = currentLanguage === "en" ? "English" : "Français";

      langButtons.forEach((btn) => {
        const check = btn.querySelector(".language-check");
        const btnLang = btn.getAttribute("data-lang");
        if (btnLang === currentLanguage) {
          btn.classList.add("text-green-400");
          if (check) check.classList.remove("opacity-0");
        } else {
          btn.classList.remove("text-green-400");
          if (check) check.classList.add("opacity-0");
        }
      });

      updateLanguageText(currentLanguage);
    }

    function updateLanguageText(lang) {
      document.querySelectorAll("[data-en]").forEach((el) => {
        const translation = el.getAttribute("data-" + lang);
        if (translation) el.textContent = translation;
      });
    }

    langButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const selected = btn.getAttribute("data-lang");
        updateLanguageUI(selected);
        if (desktopMenu) desktopMenu.classList.add("hidden");
        if (mobileMenu) mobileMenu.classList.add("hidden");
      });
    });

    updateLanguageUI(currentLanguage);
  } catch (e) {
    console.error("❌ Language script error:", e);
  }
});
</script>
<div class="absolute hidden z-50 mt-2 w-40 bg-gray-800/90 backdrop-blur-sm border border-gray-700/50 rounded-lg shadow-xl text-sm text-white" id="language-options">
<button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-700/50 text-gray-100 flex items-center gap-2" data-lang="en">
<span class="w-5 h-5 flex items-center justify-center"><i class="ri-check-line language-check opacity-0"></i></span>
<span>English</span>
</button>
<button class="w-full px-4 py-2 text-left text-sm hover:bg-gray-700/50 text-gray-100 flex items-center gap-2" data-lang="fr">
<span class="w-5 h-5 flex items-center justify-center"><i class="ri-check-line language-check opacity-0"></i></span>
<span>Français</span>
</button>
</div>
<script>
window.addEventListener("DOMContentLoaded", function () {
  function positionDropdown(button) {
    const menu = document.getElementById("language-options");
    const rect = button.getBoundingClientRect();
    menu.style.top = rect.bottom + window.scrollY + "px";
    menu.style.right = window.innerWidth - rect.right + "px";
    menu.classList.toggle("hidden");
  }

  const desktopBtn = document.getElementById("language-selector");
  if (desktopBtn) {
    desktopBtn.addEventListener("click", function () {
      positionDropdown(desktopBtn);
    });
  }

  const mobileBtn = document.getElementById("mobile-language-selector");
  if (mobileBtn) {
    mobileBtn.addEventListener("click", function () {
      positionDropdown(mobileBtn);
    });
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ---------- ждём, пока в DOM появятся все элементы ---------- */
  function waitForElements(cb) {
    const t = setInterval(() => {
      const steps         = document.querySelectorAll('.step-content');
      const progressSteps = document.querySelectorAll('.progress-step');
      let   runBtn        = document.getElementById('run-backtest-primary');
      let   nextBtn       = document.getElementById('next-step');
      let   prevBtn       = document.getElementById('prev-step');

      if (steps.length && progressSteps.length && runBtn && nextBtn && prevBtn) {
        clearInterval(t);
        cb({ steps, progressSteps, runBtn, nextBtn, prevBtn });
      }
    }, 100);
  }

  waitForElements(({ steps, progressSteps, runBtn, nextBtn, prevBtn }) => {
    let currentStep = 1;

    /* ======== ГЛАВНАЯ ФУНКЦИЯ ПЕРЕКЛЮЧЕНИЯ ШАГОВ ======== */
    function showStep(step) {
      /* —- обновляем ссылки на кнопки (если их перерисовали) */
      runBtn  = document.getElementById('run-backtest-primary');
      nextBtn = document.getElementById('next-step');
      prevBtn = document.getElementById('prev-step');

      /* —- показываем/скрываем контент шага */
      steps.forEach((el, i) => el.classList.toggle('hidden', i !== step - 1));

      /* —- настраиваем прогресс-бар */
      progressSteps.forEach((p, i) => {
        const circle = p.querySelector('.step-circle');
        const text   = p.querySelector('.progress-step-text');

        /* сброс */
        p.classList.remove('active', 'completed');
        circle.classList.remove('bg-primary', 'bg-green-500', 'text-white');
        circle.classList.add   ('bg-gray-800', 'text-gray-400');
        text.classList.remove  ('text-white');

        if (i + 1 === step) {          // текущий
          p.classList.add('active');
          circle.classList.replace('bg-gray-800', 'bg-primary');
          circle.classList.replace('text-gray-400', 'text-white');
          text.classList.add('text-white');
        } else if (i + 1 < step) {     // уже пройден
          p.classList.add('completed');
          circle.classList.replace('bg-gray-800', 'bg-green-500');
          circle.classList.replace('text-gray-400', 'text-white');
        }
      });

      /* —- состояние кнопок prev / next */
      if (prevBtn) {
        const atStart = step === 1;
        prevBtn.disabled = atStart;
        prevBtn.classList.toggle('opacity-50',       atStart);
        prevBtn.classList.toggle('cursor-not-allowed', atStart);
      }
      if (nextBtn) {
        const atEnd = step === steps.length;
        nextBtn.disabled = atEnd;
        nextBtn.classList.toggle('opacity-50',       atEnd);
        nextBtn.classList.toggle('cursor-not-allowed', atEnd);
      }

      /* —- переключаем видимость Run / Next */
      if (runBtn && nextBtn) {
        if (step === 1) {
          runBtn.classList.remove('hidden');
          nextBtn.classList.add   ('hidden');
        } else {
          runBtn.classList.add   ('hidden');
          nextBtn.classList.remove('hidden');
        }
      }

      currentStep = step;
    }

    /* экспортируем функцию наружу для custom-event */
    window.showStep = showStep;
    showStep(currentStep);

    /* —- wire-up кнопки Prev / Next */
    prevBtn.addEventListener('click', () => showStep(Math.max(1, currentStep - 1)));
    nextBtn.addEventListener('click', () => showStep(Math.min(steps.length, currentStep + 1)));
  });

  /* ---------- централизованный переход между шагами ---------- */
  document.addEventListener('goToStep', e => {
    const step = e.detail;
    if (window.showStep) window.showStep(step);
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const dropdown = document.getElementById("language-dropdown");
  const mobileDropdown = document.getElementById("mobile-language-dropdown");
  const buttons = document.querySelectorAll('[data-lang]');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      dropdown?.classList.add("hidden");
      mobileDropdown?.classList.add("hidden");
    });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const dropdown = document.getElementById('language-options');
  const currentLanguageText = document.getElementById('current-language');
  const languageButtons = document.querySelectorAll('[data-lang]');
  const languageIcons = document.querySelectorAll('.language-check');

  function setLanguage(lang) {
    localStorage.setItem('lang', lang);
    updateLanguage(lang);
    if (dropdown) {
      dropdown.classList.add('hidden');
    }
  }

  function updateLanguage(lang) {
    document.querySelectorAll('[data-en]').forEach(el => {
      el.textContent = lang === 'fr' ? el.dataset.fr : el.dataset.en;
    });
    document.querySelectorAll('[data-en-placeholder]').forEach(el => {
      el.setAttribute("placeholder", lang === 'fr' ? el.dataset.frPlaceholder : el.dataset.enPlaceholder);
    });

    languageButtons.forEach(button => {
      const isActive = button.dataset.lang === lang;
      const icon = button.querySelector('.language-check');
      if (icon) {
        icon.classList.remove('opacity-100', 'opacity-0');
        icon.classList.add(isActive ? 'opacity-100' : 'opacity-0');
      }
    });

    if (currentLanguageText) {
      currentLanguageText.textContent = lang === 'fr' ? 'Français' : 'English';
    }
  }

  const storedLang = localStorage.getItem('lang') || 'en';
  updateLanguage(storedLang);

  languageButtons.forEach(button => {
    button.addEventListener('click', () => {
      const lang = button.dataset.lang;
      if (lang) setLanguage(lang);
    });
  });
});
</script>
<script>
/* === Быстрый выбор периода 3M / 6M / 1Y === */
document.addEventListener('DOMContentLoaded', () => {
  const startEl = document.getElementById('start-date');
  const endEl   = document.getElementById('end-date');
  const btns    = document.querySelectorAll('.period-btn');

  /* вспом. формататор YYYY-MM-DD */
  const iso = d => d.toISOString().split('T')[0];

  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      /* 1. читаем конечную дату (если пусто — берём сегодня) */
      const end = endEl.value ? new Date(endEl.value) : new Date();

      /* 2. отнимаем период */
      const s   = new Date(end);                 // копия
      switch (btn.dataset.period) {
        case '3M': s.setMonth(s.getMonth() - 3); break;
        case '6M': s.setMonth(s.getMonth() - 6); break;
        case '1Y': s.setFullYear(s.getFullYear() - 1); break;
      }

      /* 3. пишем Start Date */
      startEl.value = iso(s);

      /* 4. подчеркнём активную кнопку */
      btns.forEach(b => {
        const active = b === btn;
        b.classList.toggle('bg-primary', active);
        b.classList.toggle('text-white', active);
        b.classList.toggle('bg-gray-800', !active);
        b.classList.toggle('text-gray-400', !active);
      });
    });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const allBtn   = document.getElementById('select-all');
  const noneBtn  = document.getElementById('clear-all');
  const qAll     = '.component-checkbox';

  /* выбрать все */
  allBtn.addEventListener('click', () => {
    document.querySelectorAll(qAll).forEach(cb => {
      if (!cb.checked) {
        cb.checked = true;
        cb.dispatchEvent(new Event('change'));   // ре-используем текущий хэндлер
      }
    });
  });

  /* снять всё */
  noneBtn.addEventListener('click', () => {
    document.querySelectorAll(qAll).forEach(cb => {
      if (cb.checked) {
        cb.checked = false;
        cb.dispatchEvent(new Event('change'));
      }
    });
  });
});
</script>
<!-- 💠 NEW BACKTEST FRAMEWORK -->
<script type="module">
/* ---------- Metrics utilities ---------- */
const DAY_MS = 24*60*60*1000;
const ANNUAL_DAYS = 252;

const fmt = {
  num: v => v.toFixed(2),
  pct: v => (v*100).toFixed(2) + '%'
};

/* ---------- helpers ---------- */
function collectFormParams() {
  let tickers = [];
  let source = '';

  // 1) Checked cards in Available Components
  const cards = document.querySelectorAll('input.checkbox-selection:checked');
  if (cards.length) {
    tickers = Array.from(cards).map(cb => {
      const label = cb.closest('label');
      const symEl = label && label.querySelector('span.font-semibold');
      return symEl ? symEl.textContent.trim() : null;
    }).filter(Boolean);
    if (tickers.length) source = 'checked-cards';
  }

  const model      = document.getElementById('model-type')?.value || 'price-weighted';
  const start      = document.getElementById('start-date')?.value;
  const end        = document.getElementById('end-date')?.value;
  const initialVal = Number(document.getElementById('initial-value')?.value || 100);
  const rebalance  = document.getElementById('rebalance-frequency')?.value || 'monthly';

  const params = { model, tickers, start, end, initialValue: initialVal, rebalance };
  console.log(`[collectFormParams] (${source || 'none'}) →`, params);
  return params;
}

function setText(id, txt){
  const el = document.querySelector(id);
  if(el) el.textContent = txt;
}

function setColored(id, val, percent = false){
  const el = document.querySelector(id);
  if(!el) return;

  el.classList.remove('text-green-400','text-red-400','text-gray-400');

  if(val === null || Number.isNaN(val)){
    el.textContent = 'n/a';
    el.classList.add('text-gray-400');
    return;
  }

  const positive = val >= 0;
  el.textContent = percent ? fmt.pct(val) : fmt.num(val);
  el.classList.add(positive ? 'text-green-400' : 'text-red-400');
}

function stdev(arr){
  const mean = arr.reduce((s,x)=>s+x,0)/arr.length;
  const variance = arr.reduce((s,x)=>s+(x-mean)**2,0)/(arr.length-1);
  return Math.sqrt(variance);
}

/* ---------- Core updater ---------- */
function updateMetrics(){
  console.log('updateMetrics called');
  try{
    if(!rawData || !rawData.custom?.length) return;

    const idxRaw = rawData.custom;
    const spxRaw = rawData.sp500;
    const dates  = rawData.dates.map(d=>new Date(d));

    /* sync with current display mode */
    const idxDisp = transformSeries(idxRaw, window.valueMode);
    const spxDisp = transformSeries(spxRaw, window.valueMode);
    const idxLast = idxDisp.at(-1);
    const spxLast = spxDisp.at(-1);

    setText('#metric-final-value', fmt.num(idxLast));
    setText('#bench-final',        fmt.num(spxLast));

    if(window.valueMode === 'return'){
      setColored('#bench-vs', (idxLast - spxLast)/100, true);
    }else{
      setColored('#bench-vs', idxLast/spxLast - 1, true);
    }

    /* absolute-return based metrics */
    const totalRet = idxRaw.at(-1)/idxRaw[0]-1;
    setColored('#metric-total-returns', totalRet, true);

    const dailyRet = idxRaw.slice(1).map((v,i)=>v/idxRaw[i]-1);
    const annFactor = Math.sqrt(Math.min(ANNUAL_DAYS, dailyRet.length));
    const vol = stdev(dailyRet)*annFactor;
    setText('#metric-volatility', fmt.pct(vol/100));

    const sharpe = stdev(dailyRet) ? (dailyRet.reduce((s,x)=>s+x,0)/dailyRet.length) / stdev(dailyRet) * annFactor : 0;
    setText('#metric-sharpe', fmt.num(sharpe));

    let peak = idxRaw[0], mdd = 0;
    for(const v of idxRaw){ if(v>peak) peak=v; mdd = Math.min(mdd, v/peak -1); }
    setColored('#metric-mdd', mdd, true);

    /* --- trailing returns: календарные окна --- */
    function trailingReturn(periodDays) {
      if (!dates.length) return null;

      const params  = collectFormParams();
      const endDate = new Date(params.end);                     // ← fix
      if (isNaN(endDate)) return null;                          // защита

      const startDate = new Date(endDate.getTime() - periodDays * DAY_MS);

      // ищем startIdx — первую дату ≥ startDate
      const startIdx = dates.findIndex(d => d >= startDate);
      if (startIdx === -1) return null;

      // ищем endIdx — последнюю дату ≤ endDate (двигаемся справа налево)
      let endIdx = dates.length - 1;
      while (endIdx > startIdx && dates[endIdx] > endDate) endIdx--;
      if (endIdx <= startIdx) return null;

      return idxRaw[endIdx] / idxRaw[startIdx] - 1;
    }

    /* --- вывод в интерфейс --- */
    setColored('#ret-1m', trailingReturn(30),  true);   // 1 месяц
    setColored('#ret-3m', trailingReturn(90),  true);   // 3 месяца
    setColored('#ret-1y', trailingReturn(365), true);   // 1 год

    // --- YTD ---
    const lastDate = dates.at(-1);

    // ищем ПЕРВУЮ дату текущего года (не обязательно 1 января)
    const firstIdxThisYear = dates.findIndex(
      d => d.getFullYear() === lastDate.getFullYear()
    );

    const ytd = firstIdxThisYear >= 0              // допускаем индекс 0
              ? idxRaw.at(-1) / idxRaw[firstIdxThisYear] - 1
              : null;

    setColored('#ret-ytd', ytd, true);

  }catch(err){
    console.error('updateMetrics error', err);
  }
}

/* ---------- Supabase data loader (FINAL + logs) ---------- */
async function fetchPriceTable(symbols, start, end) {
  console.log('[fetchPriceTable] request:', symbols.join(','), start, end);

  if (!window.supabase) {
    console.error('Supabase client not found!');
    return { dates: [], prices: new Map() };
  }

  const PAGE_SIZE = 1000;      // лимит PostgREST
  let from = 0;
  let rows = [];
  let page = 0;

  // ---- постраничная выборка ----
  while (true) {
    console.log(
      `[fetchPriceTable] → page ${page}  (rows ${from}-${from + PAGE_SIZE - 1})`
    );

    const { data, error } = await supabase
      .from('daily_prices')
      .select('symbol, trade_date, close')
      .in('symbol', symbols)
      .gte('trade_date', start)
      .lte('trade_date', end)
      .order('trade_date', { ascending: true })
      .range(from, from + PAGE_SIZE - 1);   // 0-999, 1000-1999, …

    if (error) {
      console.error('🛑 fetchPriceTable error:', error);
      return { dates: [], prices: new Map() };
    }

    console.log(
      `[fetchPriceTable] ← page ${page}  received: ${data.length} rows`
    );

    rows.push(...data);
    if (data.length < PAGE_SIZE) {
      console.log('[fetchPriceTable] paging complete');
      break;                                // последняя страница
    }

    from += PAGE_SIZE;
    page += 1;
  }

  if (!rows.length) {
    console.warn('⚠ No data fetched');
    return { dates: [], prices: new Map() };
  }

  /* ---------- формирование map и fill-forward (как было) ---------- */
  const dateSet  = new Set();
  const priceMap = new Map();
  symbols.forEach(sym => priceMap.set(sym, []));

  rows.forEach(r => dateSet.add(r.trade_date));
  const dates = Array.from(dateSet).sort();

  // инициализация массивов null-ами
  for (const sym of priceMap.keys()) priceMap.set(sym, Array(dates.length).fill(null));

  // заполнение цен
  rows.forEach(r => {
    const idx = dates.indexOf(r.trade_date);
    if (idx >= 0) priceMap.get(r.symbol)[idx] = Number(r.close);
  });

  // forward-fill
  for (const [sym, arr] of priceMap.entries()) {
    for (let i = 0; i < arr.length; i++) {
      if ((arr[i] === null || arr[i] === undefined) && i > 0) arr[i] = arr[i - 1];
    }
    if (arr[0] == null) {                  // back-fill первой точки
      const first = arr.find(v => v != null);
      if (first != null) arr[0] = first;
    }
  }

  console.log(
    '[fetchPriceTable] fetched symbols:', priceMap.size,
    'dates:', dates.length
  );

  return { dates, prices: priceMap };
}

/* ---------- dummy calculators (real math later) ---------- */
function calcPriceWeighted({ dates, prices }) {
  const symbols = [...prices.keys()];
  const N = symbols.length;
  console.log('[calcPriceWeighted] symbols received:', symbols, 'count', N);

  const indexSeries = dates.map((_, idx) => {
    let sum = 0;
    let valid = 0;
    for (const sym of symbols) {
      const arr = prices.get(sym);
      const p = arr[idx];
      if (p !== null && p !== undefined && !isNaN(p)) {
        sum += p;
        valid++;
      }
    }
    return valid ? sum / valid : null;
  });

  console.log('[calcPriceWeighted] finished. points:', indexSeries.length);
  return indexSeries;
}

function calcEqualWeighted({ dates, prices, initialValue, rebalance }) {
  const symbols = [...prices.keys()];
  const n = symbols.length;
  console.log('[calcEqualWeighted] symbols:', symbols, 'n', n, 'rebalance', rebalance);

  const indexSeries = Array(dates.length).fill(null);
  if (!n || dates.length === 0) return indexSeries;

  // Forward‑fill missing prices so returns can be computed
  symbols.forEach(sym => {
    const arr = prices.get(sym);
    for (let i = 0; i < arr.length; i++) {
      if (arr[i] == null && i > 0) arr[i] = arr[i-1];
    }
    prices.set(sym, arr);
  });

  // Initial weights equal
  let weights = symbols.map(_ => 1 / n);

  indexSeries[0] = initialValue;
  const startDate = new Date(dates[0]);

  for (let t = 1; t < dates.length; t++) {
    const prevIdxVal = indexSeries[t-1];
    // daily returns for each component
    const r_i = symbols.map((sym, k) => {
      const arr = prices.get(sym);
      const p_prev = arr[t-1];
      const p_now  = arr[t];
      if (p_prev == null || p_now == null || p_prev === 0) return 0;
      return (p_now / p_prev) - 1;
    });

    // portfolio return
    let r_p = 0;
    for (let k = 0; k < n; k++) r_p += weights[k] * r_i[k];

    // update index value
    const I_t = prevIdxVal * (1 + r_p);
    indexSeries[t] = I_t;

    // update weights to reflect performance drift
    const newValues = symbols.map((sym, k) => weights[k] * (1 + r_i[k]));
    const total = newValues.reduce((a,b)=>a+b, 0);
    weights = newValues.map(v => v / total);

    // check if we need to rebalance
    const dateNow = new Date(dates[t]);
    let needRebalance = false;
    if (rebalance === 'monthly') {
      needRebalance = dateNow.getMonth() !== new Date(dates[t-1]).getMonth();
    } else if (rebalance === 'quarterly') {
      const monthsDiff = (dateNow.getFullYear() - startDate.getFullYear())*12 +
                         dateNow.getMonth() - startDate.getMonth();
      needRebalance = (monthsDiff % 3 === 0) && (dateNow.getMonth() !== new Date(dates[t-1]).getMonth());
    }
    if (needRebalance) {
      weights = symbols.map(_ => 1 / n);
      // console.log('Rebalanced on', dateNow.toISOString().slice(0,10));
    }
  }

  console.log('[calcEqualWeighted] finished. points:', indexSeries.length);
  return indexSeries;
}

/* ---------- main ---------- */
async function backtest() {
  console.log('▶ backtest() invoked');
  const params = collectFormParams();
  if (!params.tickers.length) {
    console.warn('⛔ No tickers selected');
    return;
  }

  // Request component prices + benchmark
  const allSymbols = [...params.tickers, '^GSPC'];
  const { dates, prices } = await fetchPriceTable(allSymbols, params.start, params.end);

  // Separate benchmark
  const sp500 = prices.get('^GSPC') || [];
  const compPrices = new Map([...prices].filter(([sym]) => sym !== '^GSPC'));

  // Invoke model calc
  let custom = [];
  if (params.model === 'price-weighted') {
    custom = calcPriceWeighted({ dates, prices: compPrices });
  } else if (params.model === 'equal-weighted') {
    custom = calcEqualWeighted({
      dates,
      prices: compPrices,
      initialValue: params.initialValue,
      rebalance: params.rebalance
    });
  } else {
    console.error('⚠ Unsupported model:', params.model);
    return;
  }

  console.log('[backtest] done:', {
    dates: dates.length,
    custom: custom.length,
    benchmark: sp500.length
  });

  return { dates, custom, sp500 };
}

/* === Global state === */
let rawData = { dates: [], custom: [], sp500: [] };
let chart   = null;
window.valueMode = "normalize";

/* === Chart helpers === */
function transformSeries(series, mode){
  if(!series || !series.length) return [];
  const base = series[0] || 1;
  switch(mode){
    case 'normalize': return series.map(v => v / base * 100);
    case 'return':    return series.map(v => (v / base - 1)*100);
    default:          return [...series];
  }
}

function formatTooltipLabel(ctx){
  const v = ctx.parsed.y;
  return ctx.dataset.label + ': ' + (window.valueMode==='return'? v.toFixed(2)+'%': v.toFixed(2));
}

function buildChart(){
  const container = document.getElementById('performance-chart');
  if(!container) return;
  container.innerHTML = '<canvas id="chart-canvas"></canvas>';
  const ctx = document.getElementById('chart-canvas').getContext('2d');
  const config = {
    type:'line',
    data:{
      labels: rawData.dates,
      datasets:[
        {
          label:'Custom Index',
          data: transformSeries(rawData.custom, window.valueMode),
          borderColor:'rgba(87,181,231,1)',
          tension:0.25,
          pointRadius:0,
          pointHoverRadius:5
        },
        {
          label:'S&P 500',
          data: transformSeries(rawData.sp500, window.valueMode),
          borderColor:'rgba(141,211,199,1)',
          tension:0.25,
          pointRadius:0,
          pointHoverRadius:5
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      spanGaps:false,
      plugins:{
        legend:{ labels:{ color:'#f8fafc' } },
        tooltip:{ callbacks:{ label: formatTooltipLabel } }
      },
      scales:{
        x:{
          ticks:{
            color:'#cbd5e1',
            autoSkip:true,
            maxTicksLimit:6,
            maxRotation:0,
            minRotation:0,
            padding:4,
            callback:function(val){
              const label=this.getLabelForValue(val);
              const d=new Date(label);
              if(isNaN(d)) return label;
              return d.toLocaleDateString('en-US',{month:'short', day:'numeric'});
            }
          }
        },
        y:{
          ticks:{
            color:'#cbd5e1',
            callback:function(val){
              return window.valueMode==='return'? val.toFixed(0)+'%': val.toFixed(0);
            }
          }
        }
      }
    }
  };
  chart = new Chart(ctx, config);

  updateMetrics();
}

function updateChart(){
  if(!chart){ buildChart(); return; }
  chart.data.labels = rawData.dates;
  chart.data.datasets[0].data = transformSeries(rawData.custom, window.valueMode);
  chart.data.datasets[1].data = transformSeries(rawData.sp500, window.valueMode);
  chart.options.plugins.tooltip.callbacks.label = function(ctx){ const v = ctx.parsed.y; return ctx.dataset.label + ': ' + (window.valueMode==='return'? v.toFixed(2)+'%': v.toFixed(2)); };
  chart.options.scales.y.ticks.callback = function(val){ return window.valueMode==='return'? val.toFixed(0)+'%': val.toFixed(0); };
  chart.options.scales.x.ticks.callback = function(val,index,ticks){
  const label=this.getLabelForValue(val);
  const d=new Date(label);
  if(isNaN(d)) return label;
  return d.toLocaleDateString('en-US',{month:'short', day:'numeric'});
};
chart.options.scales.x.ticks.autoSkip = true;
chart.options.scales.x.ticks.maxTicksLimit = 6;
chart.options.scales.x.ticks.maxRotation = 0;
chart.options.scales.x.ticks.minRotation = 0;
chart.update();
updateMetrics();

}

/* === Button handler === */
async function backtestPipeline(e) {
  e?.preventDefault();

  const btn     = e.currentTarget;
  const spinner = document.getElementById('run-spinner');
  const label   = document.getElementById('run-text');

  /* —– показываем «Running…» —– */
  btn.disabled = true;
  btn.classList.add('opacity-60', 'cursor-not-allowed');
  spinner?.classList.remove('hidden');
  if (label) label.textContent = 'Running…';   // ← исправлено

  try {
    const params = collectFormParams();
    const result = await backtest(params);     // ваша тяжёлая функция
    rawData      = result;
    window.rawData = rawData;

    chart ? updateChart() : buildChart();
    document.dispatchEvent(new CustomEvent('goToStep', { detail: 2 }));
  } catch (err) {
    console.error(err);
    alert(err.message || 'Backtest failed');
  } finally {
    /* —– возвращаем кнопку в исходное состояние —– */
    spinner?.classList.add('hidden');
    if (label) label.textContent = 'Run Backtest';  // ← исправлено
    btn.disabled = false;
    btn.classList.remove('opacity-60', 'cursor-not-allowed');
  }
}

/* === Wiring === */
window.addEventListener('load', ()=>{
  const btn = document.getElementById('run-backtest-primary');
  if(btn) btn.addEventListener('click', backtestPipeline);

  // value mode buttons
  document.querySelectorAll('#value-mode-toggle button').forEach(b=>{
    b.addEventListener('click', ()=>{
      window.valueMode = b.dataset.mode;
      document.querySelectorAll('#value-mode-toggle button').forEach(x=>{
        x.classList.toggle('bg-blue-500', x===b);
        x.classList.toggle('bg-slate-700', x!==b);
      });
      updateChart();
    });
  });

  // progress bar navigation event
  document.addEventListener('goToStep', e=>{ const step = e.detail; if(window.showStep) window.showStep(step); });
});
</script>
</body></html>
